<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Post Creation Form</title>
    <style>
        /* --- Base Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #fff;
            line-height: 1.5;
        }

        /* --- Layout --- */
        .main {
            display: flex;
            flex-direction: column; /* Mobile first: single column */
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
            gap: 2rem;
        }

        /* Desktop layout: side-by-side */
        @media (min-width: 1024px) {
            .main {
                flex-direction: row;
                padding: 2rem;
            }
        }

        /* --- Form Container --- */
        .create_post {
            flex: 1; /* Takes available space left by preview_wrapper on desktop */
            background: #1e293b;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            /* Width remains consistent as preview_wrapper always takes up space */
        }

        @media (min-width: 640px) {
            .create_post {
                padding: 2rem; /* More padding on larger screens */
            }
        }

        /* --- Form Header --- */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 1.75rem;
            color: #f59e0b; /* Accent color */
            margin-bottom: 0.75rem;
            line-height: 1.2;
        }

        @media (min-width: 640px) {
            .header h1 {
                font-size: 2.5rem;
            }
        }

        .header p {
            color: #94a3b8; /* Lighter text color */
            font-size: 1rem;
        }

        @media (min-width: 640px) {
            .header p {
                font-size: 1.2rem;
            }
        }

        /* --- Image Upload --- */
        .image_upload_area {
            border: 2px dashed #475569;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1.5rem;
        }

        .image_upload_area:hover {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1); /* Subtle hover effect */
        }

        .image_preview {
            display: none; /* Hidden until image is selected */
            width: 100%;
            aspect-ratio: 16/9; /* Common aspect ratio */
            border-radius: 0.75rem;
            overflow: hidden;
            margin-bottom: 1rem;
            background-color: #334155; /* Placeholder background */
        }

        .image_preview img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensure image covers the area */
        }

        /* --- Form Inputs --- */
        .details_tag {
            font-size: 1rem;
            color: #e2e8f0;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .details {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            color: #fff;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            resize: none; /* Disable textarea resizing */
            transition: all 0.3s;
            min-height: 2.5rem; /* Minimum height for single-line textareas */
        }

        .details:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2); /* Focus ring */
        }

        /* --- Buttons --- */
        .post_preview_buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end; /* Align buttons to the right */
            margin-top: 2rem;
        }

        .button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 1rem;
            white-space: nowrap; /* Prevent text wrapping */
        }

        @media (max-width: 640px) {
            .button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem; /* Smaller buttons on small screens */
            }
        }

        .preview_button {
            background: #334155;
            color: #fff;
            border: 1px solid #475569;
        }

        .preview_button:hover {
            background: #475569;
        }

        .post_button {
            background: #f59e0b;
            color: #000;
        }

        .post_button:hover {
            background: #d97706; /* Darker shade on hover */
        }

        /* --- Preview Area Styling --- */

        /* Styles for the actual preview content card area */
        .preview_post {
             /* Mobile: initially hidden, takes full width when shown */
             /* Desktop: shown/hidden by JS, sits inside wrapper */
            display: none; /* Initially hidden */
            width: 100%; /* Takes full width of its container */
            will-change: transform; /* Hint to the browser for smoother rendering */
        }

         /* Styles for the wrapper that reserves space on desktop */
        .preview_wrapper {
             /* Mobile: acts like a normal div */
             width: 100%;
             margin-top: 2rem; /* Space below form on mobile */
        }


        /* Desktop styles for the wrapper */
        @media (min-width: 1024px) {
            .preview_wrapper {
                position: sticky; /* Make it sticky */
                top: 2rem;       /* Offset from top */
                flex: 0 0 40%;   /* **Takes fixed 40% width, preserves space** */
                height: calc(100vh - 4rem); /* Fill available height */
                overflow-y: auto; /* Allow internal scrolling if needed */
                margin-top: 0;   /* Reset mobile margin */
                display: block;  /* Ensure it's a block element */
            }
             /* Reset width for preview_post inside wrapper on desktop */
             .preview_post {
                 margin-top: 0; /* Reset mobile margin */
             }
        }

        /* --- Preview Card --- */
        .post_card {
            background: linear-gradient(to bottom, #1e293b, #0f172a);
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 500px; /* Limit width on smaller screens */
            margin: 0 auto; /* Center card on mobile */
        }

        @media (min-width: 1024px) {
            .post_card {
                margin: 0; /* Align to container on desktop */
                max-width: none; /* Allow full width within sidebar */
            }
        }

         /* Preview Image Container */
        #previewImageContainer {
             display: none; /* Hidden until image uploaded */
             width: 100%;
             aspect-ratio: 16/9;
             overflow: hidden;
             background-color: #334155; /* Placeholder background */
        }
         #previewImageContainer img {
             width: 100%;
             height: 100%;
             object-fit: cover;
         }


        .post_card .info {
            padding: 1.5rem;
        }

        .post_card .name {
            font-size: 1.5rem;
            color: #f59e0b;
            text-align: center;
            margin-bottom: 0.5rem;
            word-break: break-word; /* Prevent long names from overflowing */
        }

        @media (min-width: 640px) {
            .post_card .name {
                font-size: 1.8rem;
            }
        }

        .post_card .tagline {
            color: #94a3b8;
            text-align: center;
            margin-bottom: 2rem;
            font-style: italic;
            word-break: break-word;
        }

        /* Info sections within the card */
        .info_section {
            background: #1e293b; /* Slightly different background */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .info_section h4 {
            color: #f59e0b;
            font-size: 0.875rem; /* Smaller heading */
            margin-bottom: 0.5rem;
            text-transform: uppercase; /* Uppercase for style */
            letter-spacing: 0.05em;
        }

        .info_section p {
            color: #e2e8f0; /* Lighter text for content */
            word-break: break-word;
            white-space: pre-wrap; /* Preserve line breaks from textarea */
            font-size: 0.95rem;
        }
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="main">
        <div class="create_post">
            <div class="header">
                <h1>Create Your Professional Post</h1>
                <p>Design a compelling job posting to attract the perfect candidates.</p>
            </div>

            <!-- Error Message Container -->
            <div class="error-message" id="errorMessage"></div>

            <!-- Form Element -->
            <form id="postForm" enctype="multipart/form-data">
                
                <div class="image_upload_area" id="uploadArea">
                    <p>Click to upload or drag and drop</p>
                    <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;">
                        PNG (max. 2MB)
                    </p>
                </div>
                <div class="image_preview" id="imagePreview">
                    <img id="uploadedImage" src="" alt="Form Upload Preview">
                </div>
                <input type="file" id="fileInput" name="image" style="display: none;" accept=".PNG">

                <div class="details_tag">Startup Name</div>
                <textarea class="details" id="name" name="name" rows="1" placeholder="Your company's name" required></textarea>

                <div class="details_tag">Tagline</div>
                <textarea class="details" id="tagline" name="tagline" rows="2" placeholder="A short, catchy phrase that sums up your brand"></textarea>

                <div class="details_tag">Job Title</div>
                <textarea class="details" id="title" name="title" rows="1" placeholder="Position you're hiring for" required></textarea>

                <div class="details_tag">Required Skills</div>
                <textarea class="details" id="skills" name="skills" rows="3" placeholder="Skills needed for this role (comma-separated)"></textarea>

                <div class="details_tag">Job Description</div>
                <textarea class="details" id="body" name="description" rows="5" placeholder="Detailed description of the job responsibilities and expectations"></textarea>

                <div class="post_preview_buttons">
                    <button type="button" class="button preview_button" onclick="togglePreview()">Show Preview</button>
                    <button type="submit" class="button post_button" id="submitButton">
                        <span class="loading-spinner" id="loadingSpinner"></span>
                        Publish Post
                    </button>
                </div>
            </form>
        </div>

        <div class="preview_wrapper">
            <div class="preview_post" id="previewWindow">
                <div class="post_card">
                    <div id="previewImageContainer">
                         <img id="previewImage" src="" alt="Post Image Preview">
                    </div>
                    <div class="info">
                        <div class="name" id="previewName" data-placeholder="Startup Name">Startup Name</div>
                        <div class="tagline" id="previewTagline" data-placeholder="Your company tagline will appear here">Your company tagline will appear here</div>

                        <div class="info_section">
                            <h4>Position</h4>
                            <p id="previewTitle" data-placeholder="Job Title">Job Title</p>
                        </div>

                        <div class="info_section">
                            <h4>Required Skills</h4>
                            <p id="previewSkills" data-placeholder="Skills needed for this position">Skills needed for this position</p>
                        </div>

                        <div class="info_section">
                            <h4>Description</h4>
                            <p id="previewBody" data-placeholder="Detailed job description">Detailed job description</p>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
    </div>

    <!-- Success Popup -->
    <div class="popup-overlay" id="successPopup">
        <div class="popup-content">
            <div class="popup-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <div class="popup-title">Published Successfully!</div>
            <div class="popup-message">Your job post has been published and is now live for candidates to view.</div>
            <div class="popup-buttons">
                <button class="popup-button secondary" onclick="goBack()">Back to Home</button>
                <button class="popup-button primary" onclick="viewPost()">View Post</button>
            </div>
        </div>
    </div>

    <script>
        // --- Authentication Check on Page Load ---
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }
                
                const authData = await response.json();
                if (!authData.authenticated) {
                    window.location.href = '/login';
                    return;
                }
                
                // Initialize preview state after authentication
                initializePreviewState();
                
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = '/login';
            }
        });
        
        // --- DOM Element References ---
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const imagePreviewInForm = document.getElementById('imagePreview');
        const uploadedImage = document.getElementById('uploadedImage');
        const previewImageContainer = document.getElementById('previewImageContainer');
        const previewImage = document.getElementById('previewImage');
        const previewWindow = document.getElementById('previewWindow');
        const previewButton = document.querySelector('.preview_button');
        const postForm = document.getElementById('postForm');
        const submitButton = document.getElementById('submitButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const successPopup = document.getElementById('successPopup');
        const errorMessage = document.getElementById('errorMessage');
        
        // --- Global Variables ---
        let isPreviewLogicallyVisible = false;
        let currentPostId = null;
        let uploadedImageFile = null;
        
        // --- Input Fields for Real-time Update ---
        const fields = ['name', 'tagline', 'title', 'skills', 'body'];
        fields.forEach(field => {
            const element = document.getElementById(field);
            if (element) {
                element.addEventListener('input', updatePreview);
            }
            const previewElement = document.getElementById(`preview${field.charAt(0).toUpperCase() + field.slice(1)}`);
            if (previewElement && !previewElement.hasAttribute('data-placeholder')) {
                previewElement.setAttribute('data-placeholder', previewElement.textContent);
            }
        });
        
        // --- Error Handling ---
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        // --- Image Upload Handling ---
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#f59e0b';
            uploadArea.style.backgroundColor = 'rgba(245, 158, 11, 0.1)';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#475569';
            uploadArea.style.backgroundColor = 'transparent';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#475569';
            uploadArea.style.backgroundColor = 'transparent';
            if (e.dataTransfer.files.length) {
                handleImageUpload(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleImageUpload(e.target.files[0]);
            }
        });
        
        function handleImageUpload(file) {
            // Validate file type
            if (!file.type.startsWith('image/')){
                showError('Please upload an image file (SVG, PNG, JPG, GIF).');
                return;
            }
        
            // Validate file size (2MB)
            const maxSize = 2 * 1024 * 1024; // 2MB
            if (file.size > maxSize) {
                showError('Image file too large. Maximum size is 2MB.');
                return;
            }
        
            uploadedImageFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result;
        
                // Update form preview
                uploadedImage.src = imageUrl;
                imagePreviewInForm.style.display = 'block';
                uploadArea.style.display = 'none';
        
                // Update post preview
                previewImage.src = imageUrl;
                previewImageContainer.style.display = 'block';
        
                updatePreview();
            };
            reader.onerror = () => {
                showError('Error reading the image file.');
            };
            reader.readAsDataURL(file);
        }
        
        // --- Preview Functionality ---
        function togglePreview() {
            const isMobile = window.innerWidth < 1024;
            isPreviewLogicallyVisible = !isPreviewLogicallyVisible;
            previewWindow.style.display = isPreviewLogicallyVisible ? 'block' : 'none';
        
            if (isMobile) {
                if (isPreviewLogicallyVisible) {
                    previewWindow.style.minHeight = '1px';
                } else {
                    previewWindow.style.minHeight = '';
                }
            } else {
                previewWindow.style.minHeight = '';
            }
        
            previewButton.textContent = isPreviewLogicallyVisible ? 'Hide Preview' : 'Show Preview';
        
            if (isPreviewLogicallyVisible) {
                updatePreview();
            }
        }
        
        function updatePreview() {
            fields.forEach(field => {
                const inputElement = document.getElementById(field);
                const previewElement = document.getElementById(`preview${field.charAt(0).toUpperCase() + field.slice(1)}`);
                if (inputElement && previewElement) {
                    const value = inputElement.value.trim();
                    previewElement.textContent = value || previewElement.getAttribute('data-placeholder') || '';
                }
            });
        }
        
        function initializePreviewState() {
            const isMobile = window.innerWidth < 1024;
        
            if (isMobile) {
                previewWindow.style.display = 'none';
                isPreviewLogicallyVisible = false;
                previewButton.textContent = 'Show Preview';
                previewButton.style.display = 'inline-block';
                previewWindow.style.minHeight = '';
            } else {
                previewWindow.style.display = 'block';
                isPreviewLogicallyVisible = true;
                previewButton.textContent = 'Hide Preview';
                previewButton.style.display = 'inline-block';
                previewWindow.style.minHeight = '';
            }
        
            if (isPreviewLogicallyVisible) {
                updatePreview();
                if (isMobile) {
                    previewWindow.style.minHeight = '1px';
                }
            }
        }
        
        // --- Form Submission ---
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show loading state
            submitButton.disabled = true;
            loadingSpinner.style.display = 'inline-block';
            submitButton.innerHTML = '<span class="loading-spinner" style="display: inline-block;"></span>Publishing...';
        
            try {
                // Basic validation
                const name = document.getElementById('name').value.trim();
                const title = document.getElementById('title').value.trim();
                
                if (!name || !title) {
                    throw new Error('Please fill in at least the Startup Name and Job Title before publishing.');
                }
        
                // Prepare FormData exactly as backend expects
                const formData = new FormData();
                formData.append('name', name);
                formData.append('tagline', document.getElementById('tagline').value.trim());
                formData.append('title', title);
                formData.append('skills', document.getElementById('skills').value.trim());
                formData.append('description', document.getElementById('body').value.trim());
                
                // Add image if uploaded
                if (uploadedImageFile) {
                    formData.append('image', uploadedImageFile);
                }
        
                // Submit to backend endpoint
                const response = await fetch('/api/create_post', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
        
                const result = await response.json();
        
                if (response.ok && result.success) {
                    // Success - show popup
                    currentPostId = result.post_id;
                    showSuccessPopup();
                    
                    // Reset form
                    postForm.reset();
                    if (imagePreviewInForm) {
                        imagePreviewInForm.style.display = 'none';
                    }
                    if (uploadArea) {
                        uploadArea.style.display = 'block';
                    }
                    if (previewImageContainer) {
                        previewImageContainer.style.display = 'none';
                    }
                    uploadedImageFile = null;
                    
                } else {
                    // Error from server
                    throw new Error(result.detail || result.message || 'Failed to publish post');
                }
        
            } catch (error) {
                console.error('Error publishing post:', error);
                showError(error.message || 'Failed to publish post. Please try again.');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                loadingSpinner.style.display = 'none';
                submitButton.innerHTML = '<span class="loading-spinner" id="loadingSpinner"></span>Publish Post';
            }
        });
        
        // --- Success Popup Functions ---
        function showSuccessPopup() {
            successPopup.style.display = 'flex';
            successPopup.classList.add('show');
        }
        
        function hideSuccessPopup() {
            successPopup.classList.remove('show');
            setTimeout(() => {
                successPopup.style.display = 'none';
            }, 300);
        }
        
        function goBack() {
            hideSuccessPopup();
            window.location.href = '/startups/home';
        }
        
        function viewPost() {
            hideSuccessPopup();
            if (currentPostId) {
                // Use the backend endpoint to view post
                window.location.href = `/startups/post/view/${currentPostId}`;
            } else {
                window.location.href = '/startups/home';
            }
        }
        
        // --- Window Resize Handler ---
        window.addEventListener('resize', () => {
            initializePreviewState();
        });
        
        // --- Close popup on outside click ---
        successPopup.addEventListener('click', (e) => {
            if (e.target === successPopup) {
                hideSuccessPopup();
            }
        });
        </script>
        
</body>
</html>
